#!/bin/bash
# Super-agents - THE main command for local AET setup per directory

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(pwd)"
CLAUDE_DIR="$PROJECT_DIR/.claude"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to setup local AET
setup_local_aet() {
    echo -e "${GREEN}ðŸš€ Setting up AET system in $PROJECT_DIR${NC}"
    
    # Initialize AET if needed
    if [ ! -d "$CLAUDE_DIR/agents" ]; then
        echo "Initializing AET agents..."
        # Copy agent definitions from the script directory
        if [ -d "$SCRIPT_DIR/.claude/agents" ]; then
            mkdir -p "$CLAUDE_DIR"
            cp -r "$SCRIPT_DIR/.claude/agents" "$CLAUDE_DIR/"
            echo -e "${GREEN}âœ“${NC} Copied agent definitions"
        else
            echo -e "${YELLOW}Creating basic agent structure...${NC}"
            mkdir -p "$CLAUDE_DIR/agents"
            # Create a basic agent definition
            cat > "$CLAUDE_DIR/agents/developer-agent.md" <<'EOF'
# Developer Agent
Code implementation specialist
EOF
        fi
    else
        echo -e "${GREEN}âœ“${NC} AET agents already initialized"
    fi
    
    # Setup local KM server
    setup_km_server
    
    # Create local MCP bridge
    create_mcp_bridge
    
    # Setup status checker
    create_status_checker
    
    # Update CLAUDE.md
    update_claude_md
    
    echo -e "\n${GREEN}âœ… AET system ready!${NC}"
    echo -e "Run '${YELLOW}super-agents status${NC}' to check system health"
}

# Function to setup KM server
setup_km_server() {
    echo "Setting up local Knowledge Manager..."
    
    # Find available port
    PORT=5002
    while lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; do
        PORT=$((PORT + 1))
    done
    
    mkdir -p "$CLAUDE_DIR/km_server"
    echo $PORT > "$CLAUDE_DIR/km_server/port"
    
    # Copy local KM server from the script directory
    if [ -f "$SCRIPT_DIR/.claude/system/km_server.py" ]; then
        cp "$SCRIPT_DIR/.claude/system/km_server.py" "$CLAUDE_DIR/km_server/"
        chmod +x "$CLAUDE_DIR/km_server/km_server.py"
        echo -e "${GREEN}âœ“${NC} Copied local KM server"
    else
        echo -e "${YELLOW}Warning: Local KM server not found in $SCRIPT_DIR/.claude/system/${NC}"
    fi
    
    # Copy supporting files if they exist
    for file in kma_server.py kma_database.json start_km.sh; do
        if [ -f "$SCRIPT_DIR/.claude/system/$file" ]; then
            cp "$SCRIPT_DIR/.claude/system/$file" "$CLAUDE_DIR/km_server/"
        fi
    done
    
    # Create KM data directory
    export KM_DATA_DIR="$CLAUDE_DIR/km_server/data"
    mkdir -p "$KM_DATA_DIR"
    
    echo -e "${GREEN}âœ“${NC} Knowledge Manager configured on port $PORT"
}

# Function to create MCP bridge
create_mcp_bridge() {
    cat > "$CLAUDE_DIR/mcp_bridge.py" <<'EOF'
#!/usr/bin/env python3
import sys, json, os, requests
from typing import Dict, Any

class LocalKMBridge:
    def __init__(self):
        port_file = os.path.join(os.path.dirname(__file__), "km_server/port")
        if os.path.exists(port_file):
            with open(port_file) as f:
                self.port = int(f.read().strip())
                self.base_url = f"http://localhost:{self.port}"
                self.session = requests.Session()
        else:
            self.base_url = None
            self.session = None
    
    def handle_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        if not self.base_url:
            return {"error": {"code": -32000, "message": "No local KM server"}}
        
        method = request.get("method", "")
        
        if method == "initialize":
            return {"protocolVersion": "1.0.0", "serverName": "km-local", "capabilities": {"tools": True}}
        elif method == "tools/list":
            response = self.session.get(f"{self.base_url}/mcp/spec")
            spec = response.json()
            tools = [{"name": f"km__{t.get('tool_name', t.get('name'))}", 
                     "description": t.get("description", ""),
                     "parameters": t.get("parameters", [])} for t in spec.get("tools", [])]
            return {"tools": tools}
        elif method == "tools/call":
            params = request.get("params", {})
            tool_name = params.get("name", "").replace("km__", "")
            response = self.session.post(f"{self.base_url}/mcp",
                json={"jsonrpc": "2.0", "method": tool_name, 
                      "params": params.get("arguments", {}), "id": request.get("id")})
            result = response.json()
            return {"content": [{"type": "text", "text": json.dumps(result.get("result", result))}]}
        else:
            return {"error": {"code": -32601, "message": f"Method not found: {method}"}}
    
    def run(self):
        for line in sys.stdin:
            try:
                request = json.loads(line.strip())
                result = self.handle_request(request)
                response = {"jsonrpc": "2.0", "id": request.get("id")}
                if "error" in result:
                    response["error"] = result["error"]
                else:
                    response["result"] = result
                sys.stdout.write(json.dumps(response) + "\n")
                sys.stdout.flush()
            except Exception as e:
                sys.stderr.write(f"Error: {e}\n")
                sys.stderr.flush()

if __name__ == "__main__":
    LocalKMBridge().run()
EOF
    chmod +x "$CLAUDE_DIR/mcp_bridge.py"
    echo -e "${GREEN}âœ“${NC} MCP bridge created"
}

# Function to create status checker
create_status_checker() {
    cat > "$CLAUDE_DIR/status.sh" <<'EOF'
#!/bin/bash
echo "=== AET System Status ==="
CLAUDE_DIR="$(dirname "$0")"

# Check agents
if [ -d "$CLAUDE_DIR/agents" ]; then
    AGENT_COUNT=$(ls -1 "$CLAUDE_DIR/agents"/*.md 2>/dev/null | wc -l)
    echo "âœ“ $AGENT_COUNT agents configured"
else
    echo "âœ— No agents found"
fi

# Check KM server port
if [ -f "$CLAUDE_DIR/km_server/port" ]; then
    PORT=$(cat "$CLAUDE_DIR/km_server/port")
    echo "âœ“ Knowledge Manager configured for port $PORT"
else
    echo "âœ— Knowledge Manager not configured"
fi

# Check events
if [ -f "$CLAUDE_DIR/events/log.ndjson" ]; then
    EVENT_COUNT=$(wc -l < "$CLAUDE_DIR/events/log.ndjson")
    echo "âœ“ Event system ($EVENT_COUNT events)"
else
    echo "âœ— Event system not initialized"
fi

echo ""
echo "Project: $(pwd)"
EOF
    chmod +x "$CLAUDE_DIR/status.sh"
}

# Function to update CLAUDE.md
update_claude_md() {
    if [ ! -f "$PROJECT_DIR/CLAUDE.md" ]; then
        cat > "$PROJECT_DIR/CLAUDE.md" <<'EOF'
# Local AET System

This project has a complete local AET system in `.claude/`

## Quick Commands

- `super-agents` - Setup/verify AET system
- `super-agents status` - Check system health
- `super-agents clean` - Remove local AET

## Components

- 23 specialized agents in `.claude/agents/`
- Local Knowledge Manager in `.claude/km_server/`
- Event system in `.claude/events/`
- MCP bridge in `.claude/mcp_bridge.py`

The system runs entirely locally in this directory.
EOF
        echo -e "${GREEN}âœ“${NC} Created CLAUDE.md"
    fi
}

# Function to show status
show_status() {
    if [ -f "$CLAUDE_DIR/status.sh" ]; then
        "$CLAUDE_DIR/status.sh"
    else
        echo -e "${YELLOW}AET not initialized. Run 'super-agents' to set up.${NC}"
    fi
}

# Function to clean local AET
clean_aet() {
    echo -e "${YELLOW}Removing local AET system...${NC}"
    if [ -d "$CLAUDE_DIR" ]; then
        # Keep important files
        mv "$CLAUDE_DIR/events/log.ndjson" "$CLAUDE_DIR/events.backup.ndjson" 2>/dev/null || true
        
        # Remove AET files
        rm -rf "$CLAUDE_DIR/agents" "$CLAUDE_DIR/km_server" "$CLAUDE_DIR/mcp_bridge.py" "$CLAUDE_DIR/status.sh"
        
        echo -e "${GREEN}âœ“${NC} Local AET system removed"
        echo "Event log backed up to .claude/events.backup.ndjson"
    else
        echo "No AET system found in this directory"
    fi
}

# Function to start KM server
start_km_server() {
    if [ ! -f "$CLAUDE_DIR/km_server/port" ]; then
        echo -e "${RED}âœ— AET not configured. Run 'super-agents' first.${NC}"
        exit 1
    fi
    
    PORT=$(cat "$CLAUDE_DIR/km_server/port")
    
    # Check if already running
    if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} KM server already running on port $PORT"
        return 0
    fi
    
    echo -e "${GREEN}Starting Knowledge Manager on port $PORT...${NC}"
    
    # Set KM data directory
    export KM_DATA_DIR="$CLAUDE_DIR/km_server/data"
    mkdir -p "$KM_DATA_DIR"
    
    # Start local KM server
    if [ -f "$CLAUDE_DIR/km_server/km_server.py" ]; then
        cd "$CLAUDE_DIR/km_server"
        python3 km_server.py --port $PORT > server.log 2>&1 &
        KM_PID=$!
        echo $KM_PID > pid
        cd - > /dev/null
        
        # Wait for server to start
        for i in {1..10}; do
            if curl -s "http://localhost:$PORT/health" >/dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC} Knowledge Manager started (PID: $KM_PID)"
                echo -e "Logs: $CLAUDE_DIR/km_server/server.log"
                return 0
            fi
            sleep 0.5
        done
        
        echo -e "${RED}âœ— Server failed to start. Check logs: $CLAUDE_DIR/km_server/server.log${NC}"
        exit 1
    else
        echo -e "${RED}âœ— Local KM server not found. Run 'super-agents' to set it up first.${NC}"
        exit 1
    fi
}

# Function to stop KM server
stop_km_server() {
    if [ -f "$CLAUDE_DIR/km_server/pid" ]; then
        PID=$(cat "$CLAUDE_DIR/km_server/pid")
        if kill -0 $PID 2>/dev/null; then
            kill $PID
            rm "$CLAUDE_DIR/km_server/pid"
            echo -e "${GREEN}âœ“${NC} Stopped KM server (PID: $PID)"
        else
            echo -e "${YELLOW}Server not running (stale PID file)${NC}"
            rm "$CLAUDE_DIR/km_server/pid"
        fi
    else
        echo "No KM server running in this directory"
    fi
}

# Main command handling
case "${1:-setup}" in
    setup|init|"")
        setup_local_aet
        ;;
    start)
        start_km_server
        ;;
    stop)
        stop_km_server
        ;;
    restart)
        stop_km_server
        sleep 1
        start_km_server
        ;;
    status)
        show_status
        ;;
    clean|remove)
        clean_aet
        ;;
    help|--help|-h)
        echo "super-agents - Local AET system manager"
        echo ""
        echo "Usage:"
        echo "  super-agents [command]"
        echo ""
        echo "Commands:"
        echo "  setup    Initialize AET in current directory (default)"
        echo "  start    Start the KM server for this directory"
        echo "  stop     Stop the KM server"
        echo "  restart  Restart the KM server"
        echo "  status   Show AET system status"
        echo "  clean    Remove local AET system"
        echo "  help     Show this help message"
        echo ""
        echo "Each directory gets its own isolated AET system."
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'super-agents help' for usage"
        exit 1
        ;;
esac